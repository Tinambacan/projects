$(document).ready(function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});const I=document.querySelector("#assessmentDetailsTable"),R=window.innerWidth<768,y=document.getElementById("isArchived").textContent.trim()==="1";if(I){let f=function(){const t=[];c.rows().every(function(){const e=$(this.node()),s=e.find('input[type="checkbox"].score_checkbox');if(s.prop("checked")&&!s.prop("disabled")){const a=e.find('input[type="number"]').data("student-id"),o=e.find(".attendance-selector").data("student-id");a&&t.push(a),o&&t.push(o)}});const n=[...new Set(t)];return $("#selectedStudentIDs, #selectedStudentIDsAttendance").val(n.join(",")),n},x=function(){$("#type").text().trim(),f().length,$(".publish-score-btn"),$('input[name="classRecordID"]').val(),f()},T=function(){if(D)return;c.rows().data().toArray().every(e=>e.isRawScoreViewable===1)&&(D=!0,$.ajax({url:"/update-assessment-status",type:"POST",data:{assessmentID:m,classRecordID:p,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){c.ajax.reload(null,!1)},error:function(e){console.error("Error updating assessment status:",e.responseText),D=!1}}))};var O=f,C=x,B=T;let d="",m="",b="",p="",S="",w="",v="";const c=$(I).DataTable({processing:!0,serverSide:!0,ajax:{url:"/get-assessment-details-info",type:"GET",dataType:"json",dataSrc:function(t){return d=t.storedAssessmentType,m=t.assessmentID,b=t.totalItem,v=t.passingItem,p=t.classRecordID,S=t.gradingDistributionType,w=t.term,t.data}},columns:[{data:"studentID",render:function(t,n,e){return d!=="attendance"?`<input type="checkbox" class="score_checkbox text-center" data-student-id="${e.studentID}" ${e.isRawScoreViewable?"disabled":""}>`:`<input type="checkbox" class="score_checkbox text-center" data-student-id="${e.studentID}">`},orderable:!1,className:"text-center"},{data:"studentNo",className:"text-center"},{data:null,render:function(t,n,e){return`<span class=" font-bold"> 
                        ${e.studentLname},
                        </span> 
                        ${e.studentFname}`},className:"text-center"},{data:null,render:function(t,n,e){let s="";if(d==="attendance")s=`
                                <form id="assessmentFormAttendance-${e.studentID}">
                                    <input type="hidden" name="assessmentID" value="${m}">
                                    <input type="hidden" name="classRecordID" value="${p}">
                                    <select name="scores[${e.studentID}]" class="attendance-selector p-2 border-2 border-gray-300 rounded shadow-lg" data-student-id="${e.studentID}">
                                        <option value="" ${e.score?"":"selected"}>Not set</option>
                                        <option value="1.0" ${e.score==="1.0"?"selected":""}>Present</option>
                                        <option value="0.0" ${e.score==="0.0"?"selected":""}>Absent</option>
                                        <option value="0.75" ${e.score==="0.75"?"selected":""}>Late</option>
                                        <option value="N/A" ${e.score==="N/A"?"selected":""}>Excuse</option>
                                    </select>
                                </form>
                            `;else{const a=e.score===""||e.score===null?"bg-gray-100 dark:bg-gray-500":e.score>=v&&e.score<=b?"bg-[#78DC82] dark:bg-green-500 text-white":"bg-[#f87171]  dark:bg-red-500  text-white ";s=`
                                    <input type="hidden" name="assessmentID" value="${m}">
                                    <input type="hidden" name="classRecordIDScores" value="${p}">
                                
                                    <div class="score-container rounded-xl flex items-center justify-center md:w-full w-24 ${a} [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
    ${y?`<span class="font-semibold text-white">${e.score||'<div class="text-gray-700">No score</div'}</span> `:`<input type="number" name="scores[${e.studentID}]" 
                     value="${e.score||""}" 
                     class="score-input font-semibold w-10 text-center bg-gray-300 text-gray-700" 
                     data-student-id="${e.studentID}">`}
    <span class="font-semibold">/${b}</span>
</div>
                                    <input type="hidden" name="totalItem" value="${b}" readonly>
                                    <input type="hidden" name="passingItem" value="${v}" readonly>      
                                `}return s},className:"text-center"},{data:null,render:function(t,n,e){if(d==="attendance")return"";const s=e.remarks||"";return`
  <div class="remark-container flex items-center justify-center">
    ${y?`<span class="font-semibold text-gray-500">${s||" "}</span>`:`<input 
                   type="text" 
                   name="remarks[${e.studentID}]" 
                   value="${s}" 
                   maxlength="20" 
                   class="remark-input font-semibold text-center bg-gray-300 text-gray-700 w-3/4" 
                   data-student-id="${e.studentID}">
              `}
</div>

`},className:"text-center",visible:d!=="attendance"},{data:null,render:function(t,n,e){let s="";return e.isRawScoreViewable===1?s='<span class="bg-green-500 text-white p-2 rounded-md">Published</span>':e.isRawScoreViewable===0&&(s=`
                                <div class="relative group flex justify-center items-center">
                                    <button class="publish-indiv cursor-pointer" data-assessment-id="${m}" data-class-record-id="${p}" data-student-id="${e.studentID}">
                                    <input type="hidden" name="gradingType"
                                                            value="${S}" />
                                                        <input type="hidden" name="gradingTerm"
                                                            value="${w}" />
                                        <span class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-md">Unpublished</span>
                                      
                                    
                                    </button>
                                   
                            <div class="absolute bottom-full left-1/2 transform hidden group-hover:block -translate-x-1/2 z-40 mb-4">
    <div class="flex justify-center items-center text-center transition-all duration-300 relative ">
        <span class="p-2 text-sm text-white bg-[#404040] shadow-lg rounded-md">Publish Score</span>
        <div
            class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-[#404040]">
        </div>
    </div>
</div>
                               
                            `),s},className:"text-center"}],scrollX:R,pagingType:"simple",paging:!0,order:[],columnDefs:[{targets:[0],orderable:!1}],initComplete:function(){d==="attendance"?c.column(4).visible(!1):c.column(0).visible(!0)}});$(".publish-score-btn").on("click",function(t){t.preventDefault();let n=[];var e=$(this).data("assessment-id"),s=$(this).data("class-record-id");if($('input[type="checkbox"].score_checkbox:checked').each(function(){const a=$(this).data("student-id");n.push(a)}),$("#selectedStudentIDs").val(JSON.stringify(n)),!s||!e){Swal.fire({title:"Error!",text:"Missing class record or assessment information.",icon:"error",confirmButtonText:"OK"});return}n.length>0?$.ajax({url:"/notify-students-scores-batch",type:"POST",data:{classRecordID:s,selectedStudentIDs:n,selectedAssessIDs:[e],gradingType:$('input[name="gradingType"]').val(),gradingTerm:$('input[name="gradingTerm"]').val(),_token:$('meta[name="csrf-token"]').attr("content")},beforeSend:function(){$("#send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll")},success:function(a){setTimeout(function(){Swal.fire({title:"Success!",text:a.message,icon:"success",confirmButtonText:"OK"}).then(function(){c.ajax.reload()})},500)},error:function(a,o,r){Swal.fire({title:"Error!",text:a.responseJSON?a.responseJSON.message:"An error occurred while sending the notification.",icon:"error",confirmButtonText:"OK"})},complete:function(){$("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll")}}):Swal.fire({title:"Error!",text:"No student selected.",icon:"error",confirmButtonText:"OK"})}),$(document).on("click",".publish-indiv",function(){var t=$(this).data("assessment-id"),n=$(this).data("class-record-id"),e=$(this).data("student-id");const s=$('input[name="gradingType"]').val(),a=$('input[name="gradingTerm"]').val();Swal.fire({title:"Publish score?",icon:"question",showCancelButton:!0,confirmButtonText:"Publish",cancelButtonText:"No, cancel"}).then(o=>{$("#send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll"),o.isConfirmed?$.ajax({url:"/notify-students-scores-individual",method:"POST",data:{selectedAssessIDs:t,classRecordID:n,studentID:e,gradingType:s,gradingTerm:a,_token:$('meta[name="csrf-token"]').attr("content")},success:function(r){setTimeout(function(){Swal.fire({title:"Success!",text:r.message,icon:"success",confirmButtonText:"OK"}).then(function(){c.ajax.reload()})},500)},error:function(r){if(r.responseJSON&&r.responseJSON.invalidStudentAssessments){let i="";r.responseJSON.invalidStudentAssessments.forEach(function(l){i+=`Assessment: <strong>${l.assessmentName}</strong>, Student: <strong>${l.studentFname} ${l.studentLname}</strong><br>`}),Swal.fire({title:"Publish scores failed!",html:`<strong>Some students have no scores:</strong><br><br>${i}`,icon:"warning",confirmButtonText:"OK"})}else Swal.fire({title:"Error!",text:r.responseJSON?r.responseJSON.message:"An error occurred while sending the notification.",icon:"error",confirmButtonText:"OK"})},complete:function(){$("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll")}}):($("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll"))})}),$(document).ready(function(){let t=null;const n=s=>{if(s){const a=$(`input[name^="scores"][data-student-id="${s}"]`);a.length>0&&a.focus()}},e=(s,a)=>{let o;if(a==="down"||a==="enter"?o=s.closest("tr").next("tr"):a==="up"&&(o=s.closest("tr").prev("tr")),o&&o.length){const r=o.find('input[name^="scores"]');if(r.length>0)return t=r.data("student-id"),t}return null};$("#assessmentDetailsTable").on("change",'input[name^="scores"]',function(){const s=$(this),a=s.data("student-id"),o=parseInt($('input[name="totalItem"]').val());let r=s.val().trim();if(r=r===""?null:parseInt(r),r!==null&&r>o){r=0,s.val(r).addClass("border-red-500"),Swal.fire({icon:"error",title:`The score for Student ID: ${a} was adjusted to 0 as it exceeded ${o}.`,toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3});return}else s.removeClass("border-red-500");const i={};i[a]=r;const l=$('input[name="assessmentID"]').val(),u=$('input[name="classRecordIDScores"]').val();if(!l||!u){console.error("Missing required parameters.");return}const k={_token:$('meta[name="csrf-token"]').attr("content"),assessmentID:l,classRecordID:u,scores:i};t=e(s,"down"),$.ajax({url:"/store-scores",type:"POST",data:k,success:function(h){Swal.fire({icon:"success",title:h.message,toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3}),c.ajax.reload(()=>{n(t)})},error:function(h){var g;console.error("AJAX Error:",h.responseText),Swal.fire({icon:"error",title:((g=h.responseJSON)==null?void 0:g.message)||"An error occurred.",toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3})}})}),$("#assessmentDetailsTable").on("keydown",'input[name^="scores"]',function(s){const a=$(this);if(s.key==="ArrowDown"||s.key==="ArrowUp"||s.key==="Enter"){s.preventDefault();const o=s.key==="ArrowDown"||s.key==="Enter"?"down":"up";t=e(a,o),c.ajax.reload(()=>{n(t)})}})}),$(document).ready(function(){$("#assessmentDetailsTable").on("change",'input[name^="remarks"]',function(){const t=$(this),n=t.data("student-id"),e=t.val().trim(),s=t.closest("tr").find('input[name^="scores"]'),a=s.val()?parseInt(s.val()):null;if(e.length>20){Swal.fire({icon:"error",title:"Remark Too Long",text:"Remarks cannot exceed 20 characters."}),t.val("");return}const o=$('input[name="assessmentID"]').val(),r=$('input[name="classRecordIDScores"]').val(),i={_token:$('meta[name="csrf-token"]').attr("content"),assessmentID:o,classRecordID:r,scores:{[n]:a},remarks:{[n]:e}};$.ajax({url:"/save-remarks",type:"POST",data:i,success:function(l){Swal.fire({icon:"success",title:l.message,toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3})},error:function(l,u,k){var g;Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3,timerProgressBar:!0,didOpen:A=>{A.onmouseenter=Swal.stopTimer,A.onmouseleave=Swal.resumeTimer}}).fire({icon:"error",title:((g=l.responseJSON)==null?void 0:g.message)||"An error occurred."})}})}),$("#assessmentDetailsTable").on("keydown",'input[name^="remarks"]',function(t){const n=$(this);if(t.key==="ArrowDown"||t.key==="ArrowUp"||t.key==="Enter"){let e,s;t.key==="ArrowDown"?s=n.closest("tr").next("tr"):t.key==="ArrowUp"&&(s=n.closest("tr").prev("tr")),e=s.find('input[name^="remarks"]'),e.length&&e.focus(),n.trigger("change"),t.preventDefault()}})}),$(document).on("change",".attendance-selector",function(){const t=$(this).data("student-id"),n=$(this).val(),e=$("input[name='assessmentID']").val(),s=$("input[name='classRecordID']").val(),a={assessmentID:e,classRecordID:s,scores:{}};a.scores[t]=n,$.ajax({url:"/store-score-attendance",method:"POST",data:a,success:function(o){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:4e3,timerProgressBar:!0,didOpen:i=>{i.onmouseenter=Swal.stopTimer,i.onmouseleave=Swal.resumeTimer}}).fire({icon:"success",title:o.message}),c.ajax.reload()},error:function(o){console.error("Error saving score:",o.responseText)}})}),$("#assessmentFormAttendance button").on("click",function(t){t.preventDefault();const n=$('input[name="classRecordID"]').val(),e=$('input[name="assessmentID"]').val();let s=f(),a={};const o=$(this).val();s.forEach(i=>{a[i]=o});var r={assessmentID:e,classRecordID:n,scores:a};$("#selectedStudentIDs").val(JSON.stringify(s)),s.length>0?$.ajax({url:"/store-score-attendance",method:"POST",data:r,success:function(i){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:u=>{u.onmouseenter=Swal.stopTimer,u.onmouseleave=Swal.resumeTimer}}).fire({icon:"success",title:i.message}),c.ajax.reload()},error:function(i){console.error("Error updating attendance:",i)}}):Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:l=>{l.onmouseenter=Swal.stopTimer,l.onmouseleave=Swal.resumeTimer}}).fire({icon:"errror",title:"Please select at least one student."})}),$("#score_select_all").on("click",function(){const t=$(this).prop("checked");c.rows({page:"current"}).every(function(){$(this.node()).find('input[type="checkbox"].score_checkbox:not(:disabled)').prop("checked",t)}),x()}),$("#assessmentDetailsTable").on("change",'input[type="checkbox"].score_checkbox',function(){x();const t=c.rows().count(),n=f().length,e=$("#score_select_all").get(0);n===t?(e.checked=!0,e.indeterminate=!1):n===0?(e.checked=!1,e.indeterminate=!1):e.indeterminate=!0}),$(".attendance-selector").on("change",function(){var t=$("#assessmentFormAttendance");$.ajax({url:t.attr("action"),method:t.attr("method"),data:t.serialize(),success:function(n){},error:function(n){Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:s=>{s.onmouseenter=Swal.stopTimer,s.onmouseleave=Swal.resumeTimer}}).fire({icon:"success",title:"Please select at least one student."})}})});let D=!1;c.on("draw",T)}});
