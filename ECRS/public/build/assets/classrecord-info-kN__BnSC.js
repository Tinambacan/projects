$(document).ready(function(){$("#add-stud-btn").on("click",function(){$("#add-student-modal").show(),$("body").addClass("no-scroll")}),$("#close-btn-add-stud").on("click",function(){$("#add-student-modal").fadeOut(),$("body").removeClass("no-scroll")}),$("#add-stud-list-btn").on("click",function(){$("#add-student-list-modal").show(),$("body").addClass("no-scroll")}),$("#close-btn-add-stud-list").on("click",function(){$("#add-student-list-modal").fadeOut(),$("body").removeClass("no-scroll")});const o=document.querySelector("#studInfoTable"),u=window.innerWidth<768,c=document.getElementById("isArchived").textContent.trim()==="1";if(o){let d=function(){const t=[];return n.rows().every(function(){const s=$(this.node()).find('input[type="checkbox"].stud_checkbox');if(s.prop("checked")&&!s.prop("disabled")){const r=s.data("stud-id");r&&t.push(r)}}),[...new Set(t)]},m=function(){const t=d();$("#selectedStudIDs").text(t.join(", "))};var f=d,v=m;const n=$(o).DataTable({processing:!0,serverSide:!0,ajax:{url:"/get-stud-info",type:"GET",dataType:"json",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}},columns:[{data:"studentNo"},{data:"studentLname"},{data:"studentFname"},{data:"studentMname"},{data:"Sname"},{data:"email"},{data:null,render:function(t,a,e){return`
                            <div class="flex justify-center items-center gap-1 text-2xl">
                                <div class="relative group flex justify-center items-center">
                                    <i class="fa-solid fa-eye text-blue-500 hover:bg-gray-200 hover:rounded-md p-1 cursor-pointer text-xl"></i>
                                    <div
                                        class="absolute top-[-60px] left-1/2 transform hidden group-hover:block -translate-x-1/2">
                                     <div
                                        class="flex justify-center items-center text-center transition-all duration-300 relative">
                                         <span class="p-2 text-xs text-white bg-[#404040] shadow-lg rounded-md">View Info</span>
                                        <div
                                            class="absolute bottom-[-8px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-[#404040]">
                                        </div>
                                    </div>
                            </div>
                        </div>

                          ${c?"":`
                                <div class="relative group flex justify-center items-center">
                                    <i class="fa-solid fa-pen-to-square text-green-500 edit-button hover:bg-gray-200 hover:rounded-md p-1 cursor-pointer text-xl" 
                                    data-student-id="${e.studentID}" data-remarks="${e.remarks}"
                                        data-mobile="${e.mobileNo}"></i>
                                    <div
                                class="absolute top-[-60px] left-1/2 transform hidden group-hover:block -translate-x-1/2">
                                <div
                                    class="flex justify-center items-center text-center transition-all duration-300 relative">
                                    <span class="p-2 text-xs text-white bg-[#404040] shadow-lg rounded-md">Edit Info</span>
                                    <div
                                        class="absolute bottom-[-8px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-[#404040]">
                                    </div>
                                </div>
                            </div>
                                </div>
                                
                            </div>
                               `}`}}],scrollX:u,pagingType:"simple",paging:!0,order:[],lengthMenu:[10,25,50],columnDefs:[{targets:[0,6],orderable:!1},...c?[{targets:[],visible:!1}]:[]]});$("#add-stud-form").on("submit",function(t){t.preventDefault();const a=new FormData(this);$("#add-cre-send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll"),$.ajax({url:"/save-stud-info",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},method:"POST",data:a,contentType:!1,processData:!1,success:function(e){e.success?Swal.fire({title:"Success!",text:e.message,icon:"success",confirmButtonText:"OK"}).then(s=>{s.isConfirmed&&($("#add-stud-form")[0].reset(),$("#add-student-modal").fadeOut(),$("body").removeClass("no-scroll"),n.ajax.reload())}):Swal.fire({title:"Error!",text:e.message,icon:"error",confirmButtonText:"OK"})},error:function(e,s,r){let i="An error occurred: "+r;if(e.responseJSON&&e.responseJSON.message)i=e.responseJSON.message;else if(e.status===422){const l=e.responseJSON.errors;i=Object.values(l).map(function(x){return x.join(", ")}).join(`
`)}Swal.fire({title:"Error!",text:i,icon:"error",confirmButtonText:"OK"}),$("#add-cre-send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll")},complete:function(){$("#add-cre-send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll")}})}),$(document).on("submit","#add-stud-list-form",function(t){t.preventDefault(),$("#loader-modal-import").removeClass("hidden"),$("body").addClass("no-scroll");var a=new FormData(this);$.ajax({url:"/import-students",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},method:"POST",data:a,contentType:!1,processData:!1,success:function(e){if(e.status==="success")Swal.fire({title:"Success!",text:e.message,icon:"success",confirmButtonText:"OK"}).then(s=>{s.isConfirmed&&($("body").removeClass("no-scroll"),n.ajax.reload(),$("#add-student-list-modal").fadeOut())});else if(e.status==="error"){let s=Array.isArray(e.messages)?e.messages:[e.message];Swal.fire({title:"Error!",text:s,icon:"error",confirmButtonText:"OK"}).then(r=>{r.isConfirmed&&($("#add-student-list-modal").fadeOut(),$("body").removeClass("no-scroll"),n.ajax.reload())})}},error:function(e,s,r){var l;const i=((l=e.responseJSON)==null?void 0:l.message)||"An unexpected error occurred.";Swal.fire({title:"Error!",text:i,icon:"error",confirmButtonText:"OK"}).then(x=>{x.isConfirmed&&($("#add-student-list-modal").fadeOut(),$("body").removeClass("no-scroll"),n.ajax.reload())})},complete:function(){$("#loader-modal-import").fadeOut(),$("body").removeClass("no-scroll")}})}),$(document).ready(function(){$("#edit-stud-form").on("submit",function(t){t.preventDefault();var a=$(this).serialize();$.ajax({url:"/update-stud-info",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},method:"POST",data:a,success:function(e){Swal.fire({title:"Success!",text:"Student updated successfully!",icon:"success",confirmButtonText:"Ok"}).then(s=>{s.isConfirmed&&($("#edit-student-modal").fadeOut(),$("body").removeClass("no-scroll"),n.ajax.reload())})},error:function(e){if(e.status===422){let s=e.responseJSON.errors,r="";s.email&&(r+=s.email[0]+`
`),s.studentNo&&(r+=s.studentNo[0]+`
`),Swal.fire({title:"Error!",text:r.trim(),icon:"error",confirmButtonText:"Ok"})}else Swal.fire({title:"Error!",text:"Error updating student!",icon:"error",confirmButtonText:"Ok"})}})})}),$(".send-batch-stud-credentials").click(function(){const t=d();if($("#selectedStudIDs").val(t),t.length===0){Swal.fire({title:"Error!",text:"Please select at least one student.",icon:"error",confirmButtonText:"OK"});return}Swal.fire({title:"Send Account Credentials?",icon:"question",showCancelButton:!0,confirmButtonText:"Yes, send it!",cancelButtonText:"No, cancel"}).then(a=>{$("#send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll"),a.isConfirmed?$.ajax({url:"/send-student-credentials-batch",method:"POST",data:{selectedStudIDs:t,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){setTimeout(function(){Swal.fire({title:"Success!",text:e.message,icon:"success",confirmButtonText:"OK"}).then(()=>{$("body").removeClass("no-scroll"),n.ajax.reload()})},500)},error:function(e){console.error("Error sending notification:",e),setTimeout(function(){Swal.fire({title:"Error!",text:e.responseJSON?e.responseJSON.message:"An error occurred while sending the notification.",icon:"error",confirmButtonText:"OK"})},500)},complete:function(){$("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll")}}):($("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll"))})}),$(document).on("click",".send-credentials",function(){var t=$(this).data("fname"),a=$(this).data("mname"),e=$(this).data("lname"),s=$(this).data("email"),r=$(this).data("studentno");Swal.fire({title:"Send Account Credentials?",text:`Send account credentials to ${t} ${a} ${e} (${s})`,icon:"question",showCancelButton:!0,confirmButtonText:"Yes, send it!",cancelButtonText:"No, cancel"}).then(i=>{i.isConfirmed?($("#send-email-loader").removeClass("hidden"),$("body").addClass("no-scroll"),$.ajax({url:"/send-student-credentials",method:"POST",data:{fname:t,lname:e,email:s,mname:a,studentno:r,_token:$('meta[name="csrf-token"]').attr("content")},success:function(l){l.success?setTimeout(function(){Swal.fire({title:"Success!",text:l.message,icon:"success",confirmButtonText:"OK"}).then(()=>{$("body").removeClass("no-scroll"),n.ajax.reload()})},500):Swal.fire("Error","There was an issue sending the credentials.","error")},error:function(){Swal.fire("Error","There was an issue with the request.","error")},complete:function(){$("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll")}})):i.isDismissed&&($("#send-email-loader").addClass("hidden"),$("body").removeClass("no-scroll"))})}),$("#stud_select_all").on("click",function(){const t=this.checked;t?n.page.len(-1).draw():n.page.len(10).draw(),n.rows().every(function(){$(this.node()).find('input[type="checkbox"].stud_checkbox:not(:disabled)').prop("checked",t)}),m()}),$("#myTable").on("change",'input[type="checkbox"].stud_checkbox',function(){m();const t=n.rows().count(),a=d().length,e=$("#stud_select_all").get(0);a===t?(e.checked=!0,e.indeterminate=!1):a===0?(e.checked=!1,e.indeterminate=!1):e.indeterminate=!0})}});$(document).ready(function(){$(document).on("click",".fa-pen-to-square",function(){var o=$(this).closest("tr");const u=$(this).data("student-id");var c=o.find("td:eq(0)").text().trim(),f=o.find("td:eq(1)").text(),v=o.find("td:eq(2)").text(),n=o.find("td:eq(5)").text(),d=o.data("mobile"),m=o.data("remarks");$("#edit-studentID").val(u),$("#edit-studentNo").text(c),$("#edit-studentLname").val(f),$("#edit-studentFname").val(v),$("#edit-email").val(n),$("#edit-remarks").val(m),$("#edit-mobileNo").val(d),$("#edit-student-modal").show(),$("body").addClass("no-scroll")}),$("#close-btn-edit-stud").on("click",function(){$("#edit-student-modal").fadeOut(),$("body").removeClass("no-scroll")})});$(document).ready(function(){$(document).on("click",".fa-eye",function(){var o=$(this).closest("tr");o.data("student-id");var u=o.find("td:eq(0)").text(),c=o.find("td:eq(1)").text(),f=o.find("td:eq(2)").text(),v=o.find("td:eq(5)").text(),n=o.data("mobile"),d=o.data("remarks");$("#view-studentNo").text(u),$("#view-studentFname").text(f),$("#view-studentLname").text(c),$("#view-email").text(v),$("#view-mobileNo").text(n),$("#view-remarks").text(d),$("#view-student-modal").show(),$("body").addClass("no-scroll")}),$("#close-btn-view-stud").on("click",function(){$("#view-student-modal").fadeOut(),$("body").removeClass("no-scroll")})});
